import React, { useState, useRef, useEffect } from 'react';
import { Camera, Upload, Droplets, Activity, CheckCircle, AlertTriangle, ChevronRight, RefreshCw, Info, X } from 'lucide-react';

/**
 * API KEY SECURITY NOTE:
 * Fixed compatibility issue with import.meta for older build environments.
 */
const getApiKey = () => {
  try {
    return import.meta.env.VITE_GEMINI_API_KEY || "";
  } catch (e) {
    return "";
  }
};

const apiKey = getApiKey();

export default function App() {
  const [image, setImage] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [results, setResults] = useState(null);
  const [error, setError] = useState('');
  const fileInputRef = useRef(null);

  // Camera specific state and refs
  const [isCameraActive, setIsCameraActive] = useState(false);
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  // Handle file selection
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        setError('Please upload a valid image file.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (event) => {
        setImage(event.target.result);
        setResults(null);
        setError('');
      };
      reader.onerror = () => {
        setError('Failed to read the image. Please try again.');
      };
      reader.readAsDataURL(file);
    }
  };

  // Trigger file input click
  const triggerFileInput = () => {
    fileInputRef.current.click();
  };

  // Camera Functions
  const startCamera = async () => {
    setError('');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user' }
      });
      streamRef.current = stream;
      setIsCameraActive(true);
    } catch (err) {
      console.error("Error accessing camera:", err);
      setError("Could not access camera. Please check permissions or use the upload option instead.");
    }
  };

  // Attach stream to video element when it mounts
  useEffect(() => {
    if (isCameraActive && videoRef.current && streamRef.current) {
      videoRef.current.srcObject = streamRef.current;
    }
  }, [isCameraActive]);

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    setIsCameraActive(false);
  };

  const capturePhoto = () => {
    if (videoRef.current) {
      const video = videoRef.current;
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      
      // Mirror the image to match the video preview
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      setImage(dataUrl);
      setResults(null);
      setError('');
      stopCamera();
    }
  };

  // Cleanup camera on unmount
  useEffect(() => {
    return () => {
      stopCamera();
    };
  }, []);

  // Reset app state
  const handleReset = () => {
    setImage(null);
    setResults(null);
    setError('');
    stopCamera();
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  // Analyze image using Gemini Vision API
  const analyzeLips = async () => {
    if (!image) return;

    setIsAnalyzing(true);
    setError('');

    try {
      const base64Data = image.split(',')[1];
      const mimeType = image.split(';')[0].split(':')[1];

      const prompt = `
        You are an expert dermatologist and AI health assistant. Analyze this close-up image of a person's lips to detect signs of dehydration.
        Assess the lips based on the following criteria:
        1. Overall dehydration status (Well Hydrated, Mildly Dehydrated, Severely Dehydrated).
        2. Crackness (presence and severity of cracks or fissures).
        3. Dryness (presence of peeling, flakiness, or rough texture).
        4. Moisture (level of natural gloss, plumpness, or lack thereof).
        5. Color (paleness, redness, healthy pink, or bluish tints indicating issues).
        6. Provide a list of actionable recommendations to improve lip hydration based specifically on these observations.
      `;

      const responseSchema = {
        type: "OBJECT",
        properties: {
          overallStatus: { type: "STRING" },
          dehydrationScore: { type: "INTEGER" },
          crackness: { type: "STRING" },
          dryness: { type: "STRING" },
          moisture: { type: "STRING" },
          color: { type: "STRING" },
          recommendations: { type: "ARRAY", items: { type: "STRING" } }
        },
        required: ["overallStatus", "dehydrationScore", "crackness", "dryness", "moisture", "color", "recommendations"]
      };

      const payload = {
        contents: [
          {
            role: "user",
            parts: [
              { text: prompt },
              { inlineData: { mimeType: mimeType, data: base64Data } }
            ]
          }
        ],
        generationConfig: {
          responseMimeType: "application/json",
          responseSchema: responseSchema
        }
      };

      let attempt = 0;
      const maxRetries = 5;
      const delays = [1000, 2000, 4000, 8000, 16000];
      let response;

      while (attempt < maxRetries) {
        try {
          response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }
          );
          
          if (response.ok) break;
          if (attempt === maxRetries - 1) throw new Error(`HTTP error! status: ${response.status}`);
          await new Promise(res => setTimeout(res, delays[attempt]));
          attempt++;
        } catch (e) {
          if (attempt === maxRetries - 1) throw e;
          await new Promise(res => setTimeout(res, delays[attempt]));
          attempt++;
        }
      }

      const data = await response.json();
      
      if (data.candidates && data.candidates[0].content.parts[0].text) {
        const parsedResults = JSON.parse(data.candidates[0].content.parts[0].text);
        setResults(parsedResults);
      } else {
        throw new Error("Invalid response format from AI.");
      }

    } catch (err) {
      console.error(err);
      setError('An error occurred while analyzing the image. Please ensure the image is clear and your API key is configured.');
    } finally {
      setIsAnalyzing(false);
    }
  };

  const getStatusColor = (status, type = 'bg') => {
    const s = status.toLowerCase();
    if (s.includes('well')) return type === 'bg' ? 'bg-emerald-500' : 'text-emerald-600';
    if (s.includes('mild')) return type === 'bg' ? 'bg-amber-500' : 'text-amber-600';
    return type === 'bg' ? 'bg-rose-500' : 'text-rose-600';
  };

  const getStatusIcon = (status) => {
    const s = status.toLowerCase();
    if (s.includes('well')) return <CheckCircle className="w-8 h-8 text-emerald-500" />;
    if (s.includes('mild')) return <Activity className="w-8 h-8 text-amber-500" />;
    return <AlertTriangle className="w-8 h-8 text-rose-500" />;
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex justify-center">
      <div className="w-full max-w-md bg-white shadow-xl overflow-hidden flex flex-col relative sm:my-8 sm:rounded-3xl sm:border border-slate-100">
        
        <header className="bg-gradient-to-r from-cyan-600 to-blue-600 p-6 text-white text-center rounded-b-3xl shadow-md z-10">
          <Droplets className="w-10 h-10 mx-auto mb-2 text-cyan-100" />
          <h1 className="text-2xl font-bold tracking-tight">HydroLip Scanner</h1>
          <p className="text-cyan-100 text-sm mt-1 opacity-90">AI-Powered Dehydration Detection</p>
        </header>

        <main className="flex-1 overflow-y-auto p-6 flex flex-col">
          {error && (
            <div className="mb-4 p-4 bg-red-50 text-red-700 rounded-xl flex items-start text-sm border border-red-100">
              <AlertTriangle className="w-5 h-5 mr-2 flex-shrink-0 mt-0.5" />
              <p>{error}</p>
            </div>
          )}

          {!image && !isCameraActive && (
            <div className="flex-1 flex flex-col items-center justify-center">
              <div className="w-full grid grid-cols-2 gap-4 mb-8">
                <div 
                  onClick={startCamera}
                  className="aspect-square border-2 border-cyan-300 rounded-3xl bg-cyan-50 flex flex-col items-center justify-center p-4 cursor-pointer hover:bg-cyan-100 transition-colors group shadow-sm"
                >
                  <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-sm group-hover:shadow text-cyan-500 mb-3 transition-all">
                    <Camera className="w-7 h-7" />
                  </div>
                  <h3 className="text-sm font-semibold text-slate-700 text-center">Open Camera</h3>
                </div>

                <div 
                  onClick={triggerFileInput}
                  className="aspect-square border-2 border-slate-200 rounded-3xl bg-slate-50 flex flex-col items-center justify-center p-4 cursor-pointer hover:bg-slate-100 transition-colors group shadow-sm"
                >
                  <div className="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-sm group-hover:shadow text-slate-500 mb-3 transition-all">
                    <Upload className="w-7 h-7" />
                  </div>
                  <h3 className="text-sm font-semibold text-slate-700 text-center">Upload Photo</h3>
                </div>
              </div>

              <div className="mt-auto flex items-start text-sm text-slate-500 bg-slate-100 p-4 rounded-xl">
                <span className="mr-3 mt-1"><Info className="w-5 h-5 text-cyan-600" /></span>
                <p>Ensure good lighting and focus directly on the lips. This tool uses AI to estimate hydration based on visual cues and is not a substitute for professional medical advice.</p>
              </div>
            </div>
          )}

          {isCameraActive && !image && (
            <div className="flex-1 flex flex-col items-center animate-fade-in relative">
              <div className="relative w-full aspect-[3/4] max-h-[60vh] rounded-3xl overflow-hidden shadow-lg bg-black border-4 border-slate-800">
                <video 
                  ref={videoRef} 
                  autoPlay 
                  playsInline 
                  muted
                  className="w-full h-full object-cover scale-x-[-1]" 
                />
                <button 
                  onClick={stopCamera}
                  className="absolute top-4 right-4 bg-black/50 text-white p-2 rounded-full backdrop-blur-sm hover:bg-black/70 transition-colors z-10"
                >
                  <X className="w-6 h-6" />
                </button>
                <div className="absolute inset-0 pointer-events-none flex items-center justify-center">
                  <div className="w-2/3 h-1/4 border-2 border-dashed border-cyan-400/70 rounded-3xl flex items-center justify-center">
                    <span className="text-cyan-400/70 text-xs font-semibold bg-black/30 px-2 py-1 rounded-full">Align lips here</span>
                  </div>
                </div>
              </div>
              <button
                onClick={capturePhoto}
                className="mt-8 w-20 h-20 bg-cyan-500 hover:bg-cyan-600 border-4 border-cyan-100 rounded-full shadow-lg transition-all flex items-center justify-center active:scale-95 flex-shrink-0"
              >
                <Camera className="w-8 h-8 text-white" />
              </button>
            </div>
          )}

          {image && !results && !isAnalyzing && (
            <div className="flex flex-col items-center animate-fade-in">
              <div className="relative w-full aspect-square max-h-80 rounded-3xl overflow-hidden shadow-lg border-4 border-white">
                <img src={image} alt="Lips Preview" className="w-full h-full object-cover" />
                <div className="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent flex items-end justify-center p-4">
                  <button 
                    onClick={triggerFileInput}
                    className="text-white text-sm font-medium bg-black/40 px-4 py-2 rounded-full backdrop-blur-sm hover:bg-black/60 transition-colors"
                  >
                    Retake Photo
                  </button>
                </div>
              </div>
              <button
                onClick={analyzeLips}
                className="mt-8 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-cyan-600/30 transition-all flex items-center justify-center text-lg active:scale-95"
              >
                <Activity className="w-6 h-6 mr-2" />
                Analyze Hydration Level
              </button>
            </div>
          )}

          {isAnalyzing && (
            <div className="flex-1 flex flex-col items-center justify-center py-12 animate-fade-in">
              <div className="relative w-32 h-32 mb-8">
                <div className="absolute inset-0 rounded-full border-4 border-cyan-100"></div>
                <div className="absolute inset-0 rounded-full border-4 border-cyan-500 border-t-transparent animate-spin"></div>
                <div className="absolute inset-0 flex items-center justify-center">
                  <Droplets className="w-10 h-10 text-cyan-500 animate-pulse" />
                </div>
              </div>
              <h3 className="text-xl font-bold text-slate-700 mb-2">Analyzing Lips...</h3>
            </div>
          )}

          {results && !isAnalyzing && (
            <div className="flex flex-col animate-fade-in pb-8">
              <div className="flex justify-center mb-6">
                <div className="w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md relative">
                   <img src={image} alt="Analyzed" className="w-full h-full object-cover" />
                </div>
              </div>

              <div className="bg-white border border-slate-100 rounded-3xl p-6 shadow-sm mb-6 text-center">
                <div className="flex justify-center mb-3">
                  {getStatusIcon(results.overallStatus)}
                </div>
                <h2 className={`text-2xl font-bold mb-1 ${getStatusColor(results.overallStatus, 'text')}`}>
                  {results.overallStatus}
                </h2>
                <div className="mt-5 mb-2">
                  <div className="flex justify-between text-xs font-semibold text-slate-400 mb-1">
                    <span>Dehydrated</span>
                    <span className="text-slate-700">{results.dehydrationScore}% Hydrated</span>
                    <span>Optimal</span>
                  </div>
                  <div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                    <div 
                      className={`h-full rounded-full transition-all duration-1000 ${getStatusColor(results.overallStatus, 'bg')}`}
                      style={{ width: `${results.dehydrationScore}%` }}
                    ></div>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-3 mb-8">
                {[
                  { label: 'Moisture', value: results.moisture, icon: <Droplets className="w-4 h-4" /> },
                  { label: 'Crackness', value: results.crackness, icon: <Activity className="w-4 h-4" /> },
                  { label: 'Dryness', value: results.dryness, icon: <AlertTriangle className="w-4 h-4" /> },
                  { label: 'Color', value: results.color, icon: <CheckCircle className="w-4 h-4" /> }
                ].map((item, idx) => (
                  <div key={idx} className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <div className="flex items-center text-sm font-semibold text-slate-600 mb-1">
                      <span className="mr-2 text-cyan-500">{item.icon}</span>
                      {item.label}
                    </div>
                    <p className="text-sm text-slate-700 leading-relaxed">{item.value}</p>
                  </div>
                ))}
              </div>

              <h3 className="font-bold text-slate-800 mb-3 px-2 flex items-center text-sm uppercase tracking-wider">Action Plan</h3>
              <div className="bg-blue-50/50 border border-blue-100 rounded-3xl p-5 mb-6">
                <ul className="space-y-4">
                  {results.recommendations.map((rec, idx) => (
                    <li key={idx} className="flex items-start">
                      <div className="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5 mr-3 text-xs font-bold">
                        {idx + 1}
                      </div>
                      <p className="text-sm text-slate-700">{rec}</p>
                    </li>
                  ))}
                </ul>
              </div>

              <button
                onClick={handleReset}
                className="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-4 px-6 rounded-2xl transition-colors flex items-center justify-center"
              >
                <RefreshCw className="w-5 h-5 mr-2" />
                Analyze Another Photo
              </button>
            </div>
          )}

          <input 
            type="file" 
            accept="image/*" 
            ref={fileInputRef} 
            onChange={handleImageUpload} 
            className="hidden" 
          />
        </main>
      </div>
      <style dangerouslySetInnerHTML={{__html: `
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.4s ease-out forwards;
        }
      `}} />
    </div>
  );
}